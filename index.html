<!doctype html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <title>Integration example</title>
    <script type="text/javascript" src="/tiger/embed.js"></script>
    <script type="text/javascript">
        const token = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MDI4Mjg4MDIsImlhdCI6MTYwMjgwMDAwMiwiaWQiOiIxMDAxIiwibmFtZSI6ImJvc2NocmV4cm90aCIsIm5vbmNlIjoiNjMzZTI2YzEtN2YyNi00NDkwLTkwNmItZTlkYzkwZjNkMmI1IiwicGxjaGFuZGxlIjowLCJzY29wZSI6WyJyZXhyb3RoLWRldmljZS5hbGwucnd4IiwicmV4cm90aC1hdXRvbWF0aW9uLmRhdGFsYXllci54Il19.eAkB4VyCQdK8XRoUJEESGRBtHp_ofXW9rLwmOEQ9u6zy1VmFapLTBnLDbCTUdSeR5h7v2d_lWPgGJK6h1iO4b8INHdhQNXwclkOdNZREgFFDtY3OWc8UFHmLnfPGNtIwNim2OVA06c5k2_aSG7k3J7O5t9n5wtTVskYNZz1aYuNrdkaqX7gXw4piSt5EDOewL0TFslcdN3aw2OzFyi3ro91InGu2jFWBW-IFn8nui5Cy14dqOlrxOdBFqOvJ18hSQYbAlWclFBQ18NVIEXKYck9628-n1P8azniOID16IWtevhHFSI1fTO6U-KP8aM9QTnP3Q-PR7ufC-12mBVXXaUld719AvHzDOT3a_n0xesvp9YrghPZWNiKgq6U4U7_k-xfNiB4miIBtbW3dlbNRYuOq9MBhERnPpfET7qkJSpF4hvQJEBz5HOcnDBgncVW9VCiwkszdW2juHMNZQ_aGKOUivBC1rs27XyOBbDeJ8lB0ufA_7wWJp6r0O2Gzuc7RfxmlUdw_0tfKM1cIER7fZ7hsUsTAI9sXvWb0xdDXqBN1GKy_VMcCgoY10rn2ZLDSL5sSiwtb_QSg49wGm3OUvK6IoZ9GM38Yo-Gf9ENOz00EurJDvEiNdk3Isk3WWq0wksSukbS2H4gmYUXSKvzx8FaMn4uCCtC3tx7bjUnO4JA';
        let workspace;

        const onresize = function (e) {
            const blocklyArea = document.getElementById('blocksColumn');
            const blocklyDiv = document.getElementById('blocks');
            blocklyDiv.style.width = 'calc(' + blocklyArea.offsetWidth + 'px - 2rem)';
            blocklyDiv.style.height = 'calc(' + blocklyArea.offsetHeight + 'px - 2rem)';
            Blockly.svgResize(workspace);
        };
        window.addEventListener('resize', onresize, false);

        ksRunnerReady(function () {
            pxt.Cloud.apiRoot = '/ide/api/';
            pxt.Cloud.localToken = 'Bearer ' + token;
            pxt.BrowserUtils.isLocalHost = () => true;
            window.E = {
                pkg: {
                    mainPkg: pxt.runner.mainPkg
                }
            }
            pxt.editor.initEditorExtensionsAsync().then(() => pxt.Cloud.privateGetAsync('/list', true).then((res) => {
                const select = document.getElementById('projects');
                res.pkgs.forEach((pkg) => {
                    const option = document.createElement('option');
                    option.text = option.value = pkg.path;
                    select.add(option);
                });
            }));
        });

        function saveProject() {
            pxt.runner.mainPkg.
                opts.fileSystem['main.blocks'] = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace, true));
            // TODO pxt.Cloud.privatePostAsync(document.getElementById('projects').value, , true).done();
        }

        function openProject() {
            if (workspace) {
                workspace.dispose();
                pxt.blocks.cleanBlocks();
            }
            pxt.Cloud.privateGetAsync(document.getElementById('projects').value + '/text', true).then(async (projectJson) => {
                pxt.runner.mainPkg._verspec = 'empty:tsprj';
                await pxt.runner.mainPkg.host().downloadPackageAsync(pxt.runner.mainPkg, Object.keys(JSON.parse(projectJson[pxt.CONFIG_NAME]).dependencies));
                pxt.runner.mainPkg._editorPkg.setFiles(projectJson);
                await pxt.runner.mainPkg.installAllAsync();

                const opts = await pxt.runner.mainPkg.getCompileOptionsAsync();
                const program = pxtc.getTSProgram(opts);

                const blocksInfo = pxtc.getBlocksInfo(pxtc.getApiInfo(program, opts.jres));
                blocksInfo.blocks.map((b) => b.attributes.paramFieldEditor).filter((pfe) => !!pfe).forEach((pfe) =>
                    Object.keys(pfe).filter((k) => pfe[k] === 'configInstance').forEach((k) => delete pfe[k])
                );
                pxt.blocks.initializeAndInject(blocksInfo);
                opts.fileSystem['main.blocks'] = pxtc.decompiler.decompileToBlocks(blocksInfo, program.getSourceFile('main.ts'), { generateSourceMap: true }).outfiles['main.blocks'];

                /*opts.trace = true;
                opts.breakpoints = true;
                const lastCompileResult = pxtc.compile(opts);*/

                const toolbox = '<xml><block type="controls_if"></block><block type="motion_Axis_move"></block></xml>';
                workspace = Blockly.inject(document.getElementById('blocks'), {
                    move: { scrollbars: true }, zoom: { enabled: true, wheel: true, startScale: 0.5 }, readOnly: false, renderer: 'pxt', toolbox: toolbox
                });

                const xml = Blockly.Xml.textToDom(opts.fileSystem['main.blocks']);
                pxt.blocks.domToWorkspaceNoEvents(xml, workspace);
                workspace.cleanUp();

                pxt.blocks.compileAsync(workspace, blocksInfo).then((bres) => {
                    onresize();
                });
            });
        }
    </script>
</head>

<body style="height: 100%; margin: 0">
    <select id="projects" onchange="openProject()">
    </select>
    <button onclick="saveProject()">Save</button>
    <div id="content" style="height: 100%">
        <div id="blocksColumn" style="width: 100%; height: 100%">
            <div id="blocks" style="position: absolute; padding: 0;"></div>
        </div>
    </div>
</body>

</html>
