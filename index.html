<!doctype html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <title>Integration example</title>
    <link rel="stylesheet" href="/tiger/semantic.css">
    <script type="text/javascript" src="/tiger/embed.js"></script>
    <script type="text/javascript">
        const baseProjectId = /\/.*\/(.*)\/.*/.exec(location.pathname)[1];
        const token = window.sessionStorage.getItem('idm_token');
        let workspace, blocksInfo, project;
        const getTemplateProject = (id, name) => {
            const timestamp = new Date().getTime() / 1000;
            return {
                //".cloudheader.json": "{\"blobId\":\"" + id + "\",\"cloudSync\":true,\"blobCurrent\":false,\"blobVersion\":1,\"name\":\"" + name + "\",\"id\":\"" + id + "\",\"pubId\":\"\",\"pubCurrent\":false,\"saveId\":{},\"target\":\"tiger\",\"recentUse\":" + timestamp + ",\"modificationTime\":" + timestamp + ",\"path\":\"" + name + "\",\"board\":\"ctrlx\",\"_id\":\"header--" + id + "\",\"_rev\":\"1-871fac6deae68cf8dcce8a3f2e252cc4\",\"githubCurrent\":false,\"editor\":\"tsprj\",\"targetVersion\":\"0.0.0\",\"version\":1}",
                "README.md": " ",
                "main.blocks": "<xml xmlns=\"https://developers.google.com/blockly/xml\"><block type=\"pxt-on-start\" x=\"0\" y=\"0\"/></xml>",
                "main.ts": "\n",
                "motion-config.json": "{\n    \"axes\": [],\n    \"kins\": [],\n    \"points\": []\n}",
                "motion.ts": "// no instances from config...",
                "pins-config.json": "{\n    \"pins\": []\n}",
                "pins.ts": "// no instances from config...",
                "pxt.json": "{\n    \"name\": \"" + name + "\",\n    \"description\": \"\",\n    \"baseConfig\": \"handlingkit\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"motion\": \"*\",\n        \"ctrlx\": \"*\",\n        \"handlingkit\": \"workspace:" + baseProjectId + "\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"motion-config.json\",\n        \"pins-config.json\",\n        \"motion.ts\",\n        \"pins.ts\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"
            }
        };

        const onresize = function (e) {
            const blocklyArea = document.getElementById('blocksColumn');
            const blocklyDiv = document.getElementById('blocks');
            blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
            blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
            Blockly.svgResize(workspace);
        };
        window.addEventListener('resize', onresize, false);

        ksRunnerReady(function () {
            pxt.Cloud.apiRoot = '/ide/api/';
            pxt.Cloud.localToken = 'Bearer ' + token;
            pxt.BrowserUtils.isLocalHost = () => true;
            window.E = {
                pkg: {
                    mainPkg: pxt.runner.mainPkg
                }
            }
            const baseDownloadPackageAsync = pxt.runner.mainPkg.host().downloadPackageAsync;
            pxt.runner.mainPkg.host().downloadPackageAsync = (pkg, dependencies) => {
                return baseDownloadPackageAsync(pkg, dependencies).catch((e) => {
                    if (pkg.verProtocol() === 'workspace') {
                        return pxt.Cloud.privateGetAsync(pkg.verArgument() + '/text', true).then((projectJson) =>
                            pkg._editorPkg = { files: projectJson }
                        );
                    } else {
                        throw e;
                    }
                });
            };
            pxt.editor.initEditorExtensionsAsync().then(() => pxt.Cloud.privateGetAsync('/list', true).then((res) => {
                const select = document.getElementById('projects');
                const placeholder = document.createElement('option');
                placeholder.disabled = placeholder.selected = placeholder.hidden = true;
                placeholder.text = 'Select project...';
                select.add(placeholder);
                res.pkgs.filter((pkg) => pkg.header.baseConfig === baseProjectId).forEach((pkg) => {
                    const option = document.createElement('option');
                    option.text = option.value = pkg.path;
                    select.add(option);
                });
            }));
        });

        function newProject() {
            const id = pxt.Util.guidGen();
            pxt.Cloud.privatePostAsync(id, getTemplateProject(id, 'testinger'), true).done();
        }

        function saveProject() {
            project['main.blocks'] = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace, true));
            pxt.blocks.compileAsync(workspace, blocksInfo).then((compilationResult) => {
                project['main.ts'] = compilationResult.source;
                pxt.Cloud.privatePostAsync(document.getElementById('projects').value, project, true).done();
            });
        }

        function deleteProject() {
            pxt.Cloud.privateDeleteAsync(document.getElementById('projects').value).done();
        }

        function openProject() {
            if (workspace) {
                workspace.dispose();
                pxt.blocks.cleanBlocks();
            }
            pxt.Cloud.privateGetAsync(document.getElementById('projects').value + '/text', true).then(async (projectJson) => {
                pxt.runner.mainPkg._verspec = 'empty:tsprj';
                await pxt.runner.mainPkg.host().downloadPackageAsync(pxt.runner.mainPkg, Object.keys(JSON.parse(projectJson[pxt.CONFIG_NAME]).dependencies));
                pxt.runner.mainPkg._editorPkg.setFiles(projectJson);
                await pxt.runner.mainPkg.installAllAsync();
                project = projectJson;

                const opts = await pxt.runner.mainPkg.getCompileOptionsAsync();
                const program = pxtc.getTSProgram(opts);

                blocksInfo = pxtc.getBlocksInfo(pxtc.getApiInfo(program, opts.jres));
                blocksInfo.blocks.map((b) => b.attributes.paramFieldEditor).filter((pfe) => !!pfe).forEach((pfe) =>
                    Object.keys(pfe).filter((k) => pfe[k] === 'configInstance').forEach((k) => delete pfe[k])
                );
                pxt.blocks.initializeAndInject(blocksInfo);
                project['main.blocks'] = pxtc.decompiler.decompileToBlocks(blocksInfo, program.getSourceFile('main.ts'), { generateSourceMap: true }).outfiles['main.blocks'];

                /*opts.trace = true;
                opts.breakpoints = true;
                const lastCompileResult = pxtc.compile(opts);*/

                const toolbox = '<xml><block type="controls_if"></block><block type="motion_Axis_move"></block></xml>';
                workspace = Blockly.inject(document.getElementById('blocks'), {
                    move: { scrollbars: true }, zoom: { enabled: true, wheel: true, startScale: 0.5 }, readOnly: false, renderer: 'pxt', toolbox: toolbox
                });

                const xml = Blockly.Xml.textToDom(project['main.blocks']);
                pxt.blocks.domToWorkspaceNoEvents(xml, workspace);
                workspace.cleanUp();

                // pxt.blocks.compileAsync(workspace, blocksInfo).then((bres) => {
                onresize();
                // });
            });
        }
    </script>
</head>

<body class="ui segment" style="height: 100%; margin: 0">
    <div class="ui segment">
        <select id="projects" class="ui dropdown" onchange="openProject()">
        </select>
        <button class="ui button icon icon-and-text" onclick="newProject()">
            <i class="icon add icon-and-text"></i><span class="ui text">New</span>
        </button>
        <button class="ui button icon icon-and-text right floated green" onclick="saveProject()">
            <i class="icon save icon-and-text"></i><span class="ui text">Save</span>
        </button>
        <button class="ui button icon icon-and-text right floated red" onclick="deleteProject()">
            <i class="icon trash icon-and-text"></i><span class="ui text">Delete</span>
        </button>
    </div>
    <div id="content" class="ui segment" style="height: calc(100% - 110px)">
        <div id="blocksColumn" style="width: 100%; height: 100%">
            <div id="blocks" style="position: absolute; padding: 0;"></div>
        </div>
    </div>
</body>

</html>